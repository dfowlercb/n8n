{
  "name": "catalog picks - BATCHED",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "312d5d9d-c07d-419d-a3c4-b8b0ea441f47",
      "name": "When clicking 'Execute workflow'"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "10bucoPFwtqYxHhr",
          "mode": "list",
          "cachedResultName": "current_seasonal_baseline",
          "cachedResultUrl": "/projects/EgkKYeoNt3ZOmjUb/datatables/10bucoPFwtqYxHhr"
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        200,
        0
      ],
      "id": "a1b206ff-f076-4e78-a261-e4abb63e5ef9",
      "name": "PROMO RESULTS"
    },
    {
      "parameters": {
        "jsCode": "// --- CONFIGURATION ---\nconst MAX_PAGES = 64;\nconst ITEMS_PER_PAGE = 10;\nconst HERO_ITEMS_COUNT = 30;\n\nfunction cleanMoney(val) {\n  if (typeof val === 'number') return val;\n  if (!val) return 0;\n  return parseFloat(val.toString().replace(/[$,%]/g, ''));\n}\n\nlet allItems = items.map(item => {\n  const json = item.json;\n  const sales = cleanMoney(json['Promo Net Sales']);\n  const margin = cleanMoney(json['Promo Margin %']);\n  const lift = cleanMoney(json['Promo Lift Sales']);\n  const score = (sales * 0.5) + (lift * 0.2) + (margin * 1000 * 0.3);\n  \n  let cat = json['OFFICERS_CATEGORY'] || json['Category'] || 'General';\n  const desc = (json['Item Description'] || '').toUpperCase();\n  \n  if (!json['OFFICERS_CATEGORY']) {\n    if (desc.includes('BIBLE') || desc.includes('NIV') || desc.includes('ESV')) cat = 'BIBLES';\n    else if (desc.includes('HC') || desc.includes('PB') || desc.includes('BOOK')) cat = 'BOOKS';\n    else if (desc.includes('GIFT') || desc.includes('SET')) cat = 'GIFTS';\n  }\n\n  return {\n    json: {\n      ...json,\n      clean_sales: sales,\n      clean_category: cat,\n      catalog_score: score\n    }\n  };\n});\n\nallItems = allItems.filter(i => !isNaN(i.json.clean_sales));\nallItems.sort((a, b) => b.json.catalog_score - a.json.catalog_score);\nconst topItems = allItems.slice(0, MAX_PAGES * ITEMS_PER_PAGE);\n\nconst heroes = topItems.slice(0, HERO_ITEMS_COUNT);\nheroes.forEach((item, index) => {\n  const page = Math.floor(index / ITEMS_PER_PAGE) + 1;\n  item.json.Layout_Section = `Page ${page} (Hero/Best Seller)`;\n});\n\nconst body = topItems.slice(HERO_ITEMS_COUNT);\nbody.sort((a, b) => {\n  if (a.json.clean_category < b.json.clean_category) return -1;\n  if (a.json.clean_category > b.json.clean_category) return 1;\n  return b.json.catalog_score - a.json.catalog_score;\n});\n\nconst startPage = 4;\nbody.forEach((item, index) => {\n  const page = startPage + Math.floor(index / ITEMS_PER_PAGE);\n  item.json.Layout_Section = `Page ${page} (${item.json.clean_category})`;\n});\n\nconst finalCatalog = [...heroes, ...body];\nreturn finalCatalog;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        0
      ],
      "id": "b410fc2f-dc7e-4fb5-bf67-ffd51522e018",
      "name": "PICK SKUS FOR CATALOG"
    },
    {
      "parameters": {
        "jsCode": "// Create batch configuration for loading parts table\n// We'll load 10,000 records at a time\n\nconst BATCH_SIZE = 10000;\nconst TOTAL_ESTIMATED_RECORDS = 100000; // Adjust to your actual parts count\nconst TOTAL_BATCHES = Math.ceil(TOTAL_ESTIMATED_RECORDS / BATCH_SIZE);\n\n// Create batch definitions\nconst batches = [];\nfor (let i = 0; i < TOTAL_BATCHES; i++) {\n  batches.push({\n    json: {\n      batchNumber: i + 1,\n      offset: i * BATCH_SIZE,\n      limit: BATCH_SIZE,\n      totalBatches: TOTAL_BATCHES\n    }\n  });\n}\n\nreturn batches;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        0
      ],
      "id": "create-batches",
      "name": "Create Batch Config"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        800,
        0
      ],
      "id": "split-batches",
      "name": "Loop Through Batches"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "Pqqd0qZlVl1uVYpJ",
          "mode": "list",
          "cachedResultName": "n8nparts",
          "cachedResultUrl": "/projects/EgkKYeoNt3ZOmjUb/datatables/Pqqd0qZlVl1uVYpJ"
        },
        "limit": "={{ $json.limit }}",
        "options": {
          "offset": "={{ $json.offset }}"
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        1000,
        0
      ],
      "id": "load-parts-batch",
      "name": "Load Parts Batch"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "batch-complete",
              "leftValue": "={{ $json.batchNumber }}",
              "rightValue": "={{ $json.totalBatches }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1200,
        0
      ],
      "id": "check-if-last-batch",
      "name": "Last Batch?"
    },
    {
      "parameters": {
        "jsCode": "// This node aggregates ALL parts data from all batches\n// It runs only after the last batch\n\n// Get all batches from the Split in Batches node\nconst allBatchOutputs = $('Load Parts Batch').all();\n\n// Flatten all parts into a single array\nconst allParts = allBatchOutputs.map(item => item.json);\n\nconsole.log(`Total parts loaded: ${allParts.length}`);\n\n// Build lookup map by SKU for fast matching\nconst partsMap = {};\nallParts.forEach(part => {\n  if (part.SKU) {\n    partsMap[part.SKU] = part;\n  }\n});\n\n// Get catalog items\nconst catalogItems = $('PICK SKUS FOR CATALOG').all();\n\nconsole.log(`Catalog items to enrich: ${catalogItems.length}`);\n\n// Merge: enrich catalog with parts data\nconst enrichedItems = catalogItems.map(item => {\n  const sku = item.json.SKU;\n  const partsData = partsMap[sku] || {};\n  \n  return {\n    json: {\n      ...item.json,\n      ...partsData\n    }\n  };\n});\n\nconsole.log(`Enriched items: ${enrichedItems.length}`);\n\nreturn enrichedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1400,
        -100
      ],
      "id": "merge-all-data",
      "name": "Merge Catalog with Parts"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking 'Execute workflow'": {
      "main": [
        [
          {
            "node": "PROMO RESULTS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PROMO RESULTS": {
      "main": [
        [
          {
            "node": "PICK SKUS FOR CATALOG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PICK SKUS FOR CATALOG": {
      "main": [
        [
          {
            "node": "Create Batch Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Batch Config": {
      "main": [
        [
          {
            "node": "Loop Through Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Through Batches": {
      "main": [
        [
          {
            "node": "Load Parts Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Parts Batch": {
      "main": [
        [
          {
            "node": "check-if-last-batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-if-last-batch": {
      "main": [
        [
          {
            "node": "Merge Catalog with Parts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Through Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "batch-version-1",
  "meta": {
    "instanceId": "5605c9fb756bfa168d22122a14cf038f60b01d43c8353976dd886ec5e9e6d10c"
  },
  "id": "catalog-picks-batched",
  "tags": []
}
